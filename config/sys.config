[
    {lager, [
        {error_logger_hwm, 600},
        {log_root, "/var/log/hellgate"},
        {crash_log, "crash.log"},
        {handlers, [
            {lager_file_backend, [
                {file, "console.json"},
                {level, debug},
                {formatter, lager_logstash_formatter}
            ]}
        ]}
    ]},

    {scoper, [
        {storage, scoper_storage_lager}
    ]},

    {hellgate, [
        {ip, "::"},
        {port, 8022},
        {default_woody_handling_timeout, 30000},
        {net_opts, [
            % Bump keepalive timeout up to a minute
            {timeout, 60000}
        ]},
        {services, #{
            automaton           => "http://machinegun:8022/v1/automaton",
            eventsink           => "http://machinegun:8022/v1/event_sink",
            accounter           => "http://shumway:8022/accounter",
            party_management    => "http://hellgate:8022/v1/processing/partymgmt",
            customer_management => "http://hellgate:8022/v1/processing/customer_management",
            % TODO make more consistent
            recurrent_paytool   => "http://hellgate:8022/v1/processing/recpaytool",
            sequences           => "http://sequences:8022/v1/sequences"
        }},
        {proxy_opts, #{
            transport_opts => #{
                connect_timeout => 1000,
                recv_timeout    => 40000
            }
        }},
        {health_checkers, [
            {erl_health, disk     , ["/", 99]       },
            {erl_health, cg_memory, [99]            },
            {erl_health, service  , [<<"hellgate">>]}
        ]},
        {payment_retry_policy, #{
            processed => {exponential, {max_total_timeout, 30}, 2, 1},
            captured => no_retry,
            refunded => no_retry
        }}
    ]},

    {dmt_client, [
        {cache_update_interval, 5000}, % milliseconds
        {max_cache_size, #{
            elements => 20,
            memory => 52428800 % 50Mb
        }},
        {service_urls, #{
            'Repository' => <<"dominant:8022/v1/domain/repository">>,
            'RepositoryClient' => <<"dominant:8022/v1/domain/repository_client">>
        }}
    ]},

    {party_client, [
        {services, #{
            party_management => "http://hellgate:8022/v1/processing/partymgmt"
        }},
        {woody, #{
            cache_mode => safe,  % disabled | safe | aggressive
            options => #{
                woody_client => #{
                    event_handler => scoper_woody_event_handler
                }
            }
        }}
    ]}
].
